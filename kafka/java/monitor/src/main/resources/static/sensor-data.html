<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sensor Data</title>
  <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <script src="/webjars/jquery/jquery.min.js"></script>
  <script src="/webjars/bootstrap/js/bootstrap.min.js"></script>
  <script src="/webjars/sockjs-client/sockjs.min.js"></script>
  <script src="/webjars/stomp-websocket/stomp.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Sensor Data</h1>
  <table class="table table-striped">
    <thead>
    <tr>
      <th>Window Start</th>
      <th>Window End</th>
      <th>Air Quality</th>
      <th>Gas Resistance</th>
      <th>Humidity</th>
      <th>Indexed Air Quality</th>
      <th>Air Pressure</th>
      <th>Relative Humidity</th>
      <th>Room Temperature</th>
      <th>Air Temperature</th>
    </tr>
    </thead>
    <tbody id="sensor-data">
    <!-- Sensor data will be appended here by JavaScript -->
    </tbody>
  </table>
  <h2>Critical Sensor Data</h2>
  <div id="critical-data">
    <!-- Critical sensor data will be appended here by JavaScript -->
  </div>
</div>
<script>
  var stompClient = null;

  function connect() {
    var socket = new SockJS('/gs-guide-websocket');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe('/topic/critical-data', function (message) {
        showCriticalData(JSON.parse(message.body));
      });
    });
  }

  function showCriticalData(message) {
    var criticalDataHtml = '<div class="alert alert-danger">' +
            'ALERT! Critical sensor data received: ' + JSON.stringify(message) +
            '</div>';
    $('#critical-data').append(criticalDataHtml);
  }

  $(document).ready(function () {
    $.ajax({
      url: "/sensor-data",
      method: "GET",
      success: function (data) {
        console.log("Fetched data:", data); // Log the data to check its structure
        var sensorDataHtml = '';
        data.forEach(function (sensor) {
          console.log("Processing sensor data:", sensor); // Log each sensor data item
          sensorDataHtml += '<tr>' +
                  '<td>' + sensor.windowStart + '</td>' +
                  '<td>' + sensor.windowEnd + '</td>' +
                  '<td>' + sensor.aggregate.averageAirQuality + '</td>' +
                  '<td>' + sensor.aggregate.averageGasResistance + '</td>' +
                  '<td>' + sensor.aggregate.averageHumidity + '</td>' +
                  '<td>' + sensor.aggregate.averageIndexedAirQuality + '</td>' +
                  '<td>' + sensor.aggregate.averageAirPressure + '</td>' +
                  '<td>' + sensor.aggregate.averageRelativeHumidity + '</td>' +
                  '<td>' + sensor.aggregate.averageRoomTemperature + '</td>' +
                  '<td>' + sensor.aggregate.averageAirTemperature + '</td>' +
                  '</tr>';
        });
        console.log("Generated HTML:", sensorDataHtml); // Log the generated HTML
        $('#sensor-data').html(sensorDataHtml);
      },
      error: function (error) {
        console.log("Error fetching sensor data", error);
      }
    });

    connect();
  });
</script>
</body>
</html>
